<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href='/main.css' rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>

<body class="grey-bg">
    <%- include('nav.ejs', {user : user}) %>

        <div class="container">
            <h3 style="padding-top: 20px;">ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒ</h3>


            <form class="d-flex" action="/search" method="POST">
                <input class="search-input" name="search_words" placeholder="Search">
                <button class="btn search-btn" type="submit">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </form>
            <div class="row">
                <% for(let i=0; i < ê¸€ëª©ë¡.length; i++){ %>
                    <div class="col-md-6  col-xl-3">
                        <div class="card shadow card-list">
                            <div style="height: 250px;">
                                <img src="<%= ê¸€ëª©ë¡[i].img %>" class="card-img-top"
                                    style="object-fit: cover; height: 250px;">
                            </div>
                            <div class="card-body">

                                <h5 class="card-title">
                                    <a href="/detail/<%= ê¸€ëª©ë¡[i]._id %>">
                                        <%= ê¸€ëª©ë¡[i].title %>
                                    </a>
                                </h5>
                                <p class="card-text">
                                    <%= ê¸€ëª©ë¡[i].content.length> 28 ? ê¸€ëª©ë¡[i].content.slice(0, 28) + '...' :
                                        ê¸€ëª©ë¡[i].content
                                        %>
                                </p>
                                <p>
                                    ê¸€ì“´ì´ : <%= ê¸€ëª©ë¡[i].writer %>
                                </p>

                                <a href="/edit/<%= ê¸€ëª©ë¡[i]._id %>"> âœï¸ </a>
                                <span class="delete" data-id="<%= ê¸€ëª©ë¡[i]._id %>">ğŸ—‘ï¸</span>
                            </div>
                        </div>
                    </div>
                    <% } %>

                        <div class="prev-next">
                            <a class="none-a" href="/list/prev/<%= ê¸€ëª©ë¡[0]._id %>">ì´ì „</a>
                            <a class="none-a" href="/list/next/<%= ê¸€ëª©ë¡[ê¸€ëª©ë¡.length-1]._id %>">ë‹¤ìŒ</a>
                        </div>

            </div>
        </div>
        <script>
            window.onload = function () {
                var images = document.querySelectorAll('img');

                images.forEach(function (img) {
                    if (!img.getAttribute('src') || img.getAttribute('src').trim() === '') {
                        img.parentNode.removeChild(img);
                    }
                });
            };
        </script>

        <script>


            //form íƒœê·¸ë¡œ get postìš”ì²­ì„ í•˜ë©´ ìƒˆë¡œê³ ì¹¨ì´ ë¨
            // -> ajaxë¡œ deleteìš”ì²­ ì‹œ bodyê°€ ì˜ ì•ˆê°€ëŠ” ê²½ìš° ìˆìŒ 
            // -> querystring ì´ìš©
            for (let i = 0; i < '<%=ê¸€ëª©ë¡.length%>'; i++) {
                document.querySelectorAll('.delete')[i].addEventListener('click', function (e) {
                    fetch('/delete?docid=' + e.target.dataset.id, {//e.targetì„ í™œìš©í•˜ì—¬ querystringìœ¼ë¡œ id ì „ì†¡
                        method: 'DELETE'
                    })//fetchì´í›„ì— ì‹¤í–‰ë  ì½”ë“œ
                        .then((r) => {
                            if (r.status == 200) {//ì„œë²„ê°€ ì„±ê³µ status ì „ì†¡ì‹œ
                                return r.text() //ì„œë²„ê°€ ë³´ë‚¸ê²Œ textë©´ r.text(), Array,Objectë©´ r.Json ë°˜í™˜
                            } else {
                                //ì„œë²„ê°€ ì—ëŸ¬ì „ì†¡ì‹œ
                                window.location.href = '/login';
                            }
                        })
                        .then((result) => {
                            //ì„±ê³µì‹œ ì‹¤í–‰ì½”ë“œ 
                            console.log(result)
                        })
                        .catch((error) => {
                            //ì¸í„°ë„·ë¬¸ì œ ë“±ìœ¼ë¡œ ì‹¤íŒ¨ì‹œ ì‹¤í–‰ì½”ë“œ
                            console.log(error)
                        })
                        .then(() => {
                            e.target.parentElement.parentElement.style.display = 'none'//ì´ë¯¸ì§€ìƒìœ¼ë¡œ ìˆ¨ê²¨ì£¼ëŠ” ì½”ë“œ

                        })

                })
            }


            // //server sent events ì‚¬ìš© ì½”ë“œ
            // let eventSource = new EventSource('/stream/list')
            // eventSource.addEventListener('msg', function(e){
            //     console.log(e.data)
            //     let gottedItem = JSON.parse(e.data)
            //     document.querySelector('.white-bg').insertAdjacentHTML('afterbegin', `<div class="list-box"><h4>${gottedItem.title}</h4></div>`)
            // })


            'https://www.google.com/url?sa=i&url=https%3A%2F%2Fblog.naver.com%2Fosy2201%2F221220725720%3FviewType%3Dpc&psig=AOvVaw33EU3221IjwaSCWarq14jm&ust=1706335182670000&source=images&cd=vfe&opi=89978449&ved=0CBIQjRxqFwoTCNDcsoaw-oMDFQAAAAAdAAAAABAD'

        </script>
        <!-- ì„œë²„ë¡œ ë°ì´í„°ë³´ë‚´ëŠ” ë‹¤ë¥¸ ë°©ë²• : 
    1. <form>  2. ajaxì´ìš©
    3. query string(ë³´ì•ˆì·¨ì•½)  4. URL parmeter(ë³´ì•ˆì·¨ì•½) -->

</body>

</html>